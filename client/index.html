<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#FFEB3B" id="theme" />
  <link rel="icon" href="/static/icon-256.png">
  <title>The Josh Mills Anger Advisory System</title>
  <link defer rel="stylesheet" href="/static/style.css" />
</head>

<body>
  <div class="content">
    <div class="container">
      <img src="/static/arrow.png" class="pointer" />
      <div class="intro">
        <h1>The Josh Mills Anger Advisory System</h1>
      </div>
      <div class="chart-container">
      </div>
    </div>
  </div>
  <script defer>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('/sw.js').then(function (registration) {
          // Registration was successful
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }).catch(function (err) {
          // registration failed :(
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
    document.addEventListener("DOMContentLoaded", _ => {
      loadChartItems();
      startUpdate();
    });

    function loadChartItems() {
      const xhr = new XMLHttpRequest();
      const url = `/api/levels`;
      xhr.open("GET", url, true);
      xhr.onload = _ => {
        const resp = JSON.parse(xhr.responseText);
        for (var key in resp) {
          if (resp.hasOwnProperty(key)) {
            let e = resp[key];
            let item = document.createElement("div");
            item.style.background = e["background"];
            item.classList.add("chart-item");
            item.setAttribute("data-level", key);

            let title = document.createElement("h1");
            title.classList.add("item-title");
            title.innerHTML = e["title"];
            item.appendChild(title);

            let desc = document.createElement("div");
            desc.classList.add("item-description");
            desc.innerHTML = e["description"];
            item.appendChild(desc);

            document.querySelector(".chart-container").appendChild(item);
          }
        }
      }
      xhr.send(null);

    }

    function startUpdate() {
      window.setInterval(updateLevel, 500)
    }

    function updateLevel() {
      let pointer = document.querySelector(".pointer");
      const xhr = new XMLHttpRequest();
      const url = `/api/currentlevel`;
      xhr.open("GET", url, true);
      xhr.onload = _ => {
        const resp = JSON.parse(xhr.responseText);
        let target = document.querySelector(`[data-level="${resp}"]`);
        let rect = target.getBoundingClientRect();
        pointer.style.top = `${rect.top}px`;
        pointer.style.right = `${rect.right + 10}px`;
        document.querySelector("#theme").setAttribute("content", target.style.background);
      }
      xhr.send(null);
    }

  </script>
</body>

</html>
